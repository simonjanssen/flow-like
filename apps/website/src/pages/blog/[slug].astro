---
import { getCollection } from "astro:content";
import "@tm9657/flow-like-ui/global.css";
import "../../styles/Blog.css";
import BlogLayout from "../../layouts/BlogLayout.astro";
import { LuCopy, LuShare } from "react-icons/lu";

export async function getStaticPaths() {
  const all = await getCollection("blog", ({ data }) =>
    import.meta.env.PROD ? !data.draft : true,
  );
  return all.map((entry) => ({
    params: { slug: entry.slug.split("-").slice(3).join("-") },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();
const { title, description, date, tags = [], cover } = entry.data;

const site = Astro.site ?? import.meta.env.SITE;
const canonical = site ? new URL(Astro.url.pathname, site).toString() : "";
---

<BlogLayout data={entry.data} content={Content}>
  <a
  href="/blog/"
  class="inline-flex items-center rounded-md px-2 py-1 text-sm hover:text-primary transition mb-2"
>
  ← Back to blog
</a>

  <div class="relative">
    {
      cover && (
        <header class="relative mb-8 md:mb-10">
          <div class="relative h-[36vh] min-h-[240px] max-h-[420px] overflow-hidden rounded-xl border">
            <img
              src={cover}
              alt=""
              class="absolute inset-0 h-full w-full object-cover"
              loading="eager"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-black/10" />
            <div class="absolute z-10 flex h-full items-end">
              <div class="w-full p-5 sm:p-7 md:p-8">
                <h1 class="text-white drop-shadow-md text-2xl sm:text-3xl md:text-4xl font-bold leading-tight pt-0!">
                  {title}
                </h1>
                <p class="mt-2 text-white/90 max-w-3xl drop-shadow">
                  {description}
                </p>
                <div class="mt-3 flex flex-wrap items-center gap-3 text-white/80 text-sm">
                  <time datetime={new Date(date).toISOString()}>
                    {new Date(date).toDateString()}
                  </time>
                  <span aria-hidden="true">•</span>
                  <span id="reading-time">— min read</span>
                </div>
                <div class="flex flex-wrap gap-2 mt-3 h-0 md:h-fit opacity-0 md:opacity-100">
                  {tags.map((t: string) => (
                    <a
                      href={`/tags/${encodeURIComponent(t)}/`}
                      class="rounded-full border border-white/30 bg-black/30 px-2 py-0.5 text-xs text-white/90 backdrop-blur-[2px] hover:border-white/50 hover:bg-black/40 transition"
                    >
                      #{t}
                    </a>
                  ))}
                </div>
              </div>
            </div>
          </div>
        </header>
      )
    }

    {
      !cover && (
        <header class="mb-8 md:mb-10">
          <h1 class="text-3xl md:text-4xl font-bold">{title}</h1>
          <p class="mt-2 text-muted-foreground">{description}</p>
          <div class="mt-3 flex flex-wrap items-center gap-3 text-sm text-muted-foreground">
            <time datetime={new Date(date).toISOString()}>
              {new Date(date).toDateString()}
            </time>
            <span aria-hidden="true">•</span>
            <span id="reading-time">— min read</span>
            {tags.length > 0 && (
              <>
                <span aria-hidden="true">•</span>
                <div class="flex flex-wrap gap-2">
                  {tags.map((t: string) => (
                    <a
                      href={`/tags/${encodeURIComponent(t)}/`}
                      class="rounded-full border px-2 py-0.5 text-xs hover:-translate-y-0.5 transition"
                    >
                      #{t}
                    </a>
                  ))}
                </div>
              </>
            )}
          </div>
        </header>
      )
    }

    <div class="mx-auto max-w-7xl px-4 sm:px-6">
      <div class="grid gap-8 lg:grid-cols-[260px_minmax(0,1fr)]">
        <aside class="hidden lg:block">
          {
            headings?.length > 0 && (
              <nav class="sticky top-24 h-max rounded-lg border bg-card/60 backdrop-blur p-4 text-sm">
                <p class="mb-2 font-medium text-muted-foreground">
                  On this page
                </p>
                <ul class="space-y-1">
                  {headings
                    .filter((h) => h.depth <= 3 && h.slug)
                    .map((h) => (
                      <li class={`pl-${(h.depth - 2) * 3} toc-item`}>
                        <a
                          href={`#${h.slug}`}
                          data-slug={h.slug}
                          class="toc-link block rounded px-2 py-1 text-muted-foreground hover:text-foreground"
                        >
                          {h.text}
                        </a>
                      </li>
                    ))}
                </ul>
              </nav>
            )
          }
        </aside>

        <article
          id="post-content"
          class="prose prose-zinc dark:prose-invert max-w-none"
        >
          <Content />
          <hr class="my-10" />
          <div class="flex flex-wrap gap-2 justify-between items-center">
            <div class="flex flex-wrap gap-2">
              {
                tags.map((t: string) => (
                  <a
                    href={`/tags/${encodeURIComponent(t)}/`}
                    class="rounded-full border px-2 py-0.5 text-xs hover:-translate-y-0.5 transition"
                  >
                    #{t}
                  </a>
                ))
              }
            </div>
            <div class="flex items-center gap-2">
              <button
                data-copy-link
                class="rounded-md border px-2.5 py-1.5 text-xs hover:bg-accent transition. flex flex-row items-center gap-2"
                >
                <LuCopy/>
                Copy link
                </button
              >
              <button
                data-web-share
                class="rounded-md border px-2.5 py-1.5 text-xs hover:bg-accent transition. flex flex-row items-center gap-2"
                >
                <LuShare/>
                Share
                </button
              >
            </div>
          </div>
        </article>
      </div>
    </div>
  </div>

  <div class="fixed inset-x-0 top-0 z-40 h-1">
    <div
      id="progress"
      class="h-full origin-left scale-x-0 bg-primary transition-[transform] duration-100"
    >
    </div>
  </div>

  <script type="module" define:vars={{ title, description, canonical }}>
    const $ = (s, r = document) => r.querySelector(s);
    const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
    const clamp = (n, a, b) => Math.min(b, Math.max(a, n));

    const article = $("#post-content");
    const bar = $("#progress");
    const timeEl = $("#reading-time");
    const copyBtn = $("[data-copy-link]");
    const shareBtn = $("[data-web-share]");

    const setProgress = () => {
      if (!article || !bar) return;
      const start = article.offsetTop;
      const end = start + article.offsetHeight - innerHeight;
      const p = clamp((scrollY - start) / (end - start), 0, 1);
      bar.style.transform = `scaleX(${p || 0})`;
    };

    const setReadingTime = () => {
      if (!article || !timeEl) return;
      const text = article.textContent || "";
      const words = (text.match(/\S+/g) || []).length;
      const mins = Math.max(1, Math.round(words / 200));
      timeEl.textContent = `${mins} min read`;
    };

    const getUrl = () => canonical || location.href;

    const copyLink = async () => {
      const url = getUrl();
      try {
        if (navigator.clipboard?.writeText) {
          await navigator.clipboard.writeText(url);
        } else {
          const ta = document.createElement("textarea");
          ta.value = url;
          ta.style.position = "fixed";
          ta.style.opacity = "0";
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
        }
        if (copyBtn) {
          const old = copyBtn.textContent;
          copyBtn.textContent = "Copied";
          setTimeout(() => (copyBtn.textContent = old || "Copy link"), 1200);
        }
      } catch {}
    };

    const webShare = async () => {
      const data = { title, text: description || "", url: getUrl() };
      if (navigator.share) {
        try {
          await navigator.share(data);
          return;
        } catch {}
      }
      copyLink();
    };

    copyBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      copyLink();
    });
    shareBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      webShare();
    });

    setReadingTime();
    setProgress();
    const links = $$(".toc-link");
    if (links.length) {
      const bySlug = Object.fromEntries(links.map((l) => [l.dataset.slug, l]));
      const obs = new IntersectionObserver(
        (entries) => {
          for (const e of entries) {
            const link = bySlug[e.target.id];
            if (!link) continue;
            link.classList.toggle("text-foreground", e.isIntersecting);
            link.classList.toggle("font-medium", e.isIntersecting);
          }
        },
        { rootMargin: "0px 0px -70% 0px", threshold: 0 },
      );
      $$("#post-content h2[id], #post-content h3[id]").forEach((h) =>
        obs.observe(h),
      );
    }
    addEventListener("scroll", () => requestAnimationFrame(setProgress), {
      passive: true,
    });
    addEventListener("resize", () => requestAnimationFrame(setProgress));
  </script>

  <style>
    .toc-link.font-medium {
      color: var(--foreground);
    }
    @media (prefers-reduced-motion: reduce) {
      #progress {
        transition: none;
      }
    }
  </style>
</BlogLayout>
